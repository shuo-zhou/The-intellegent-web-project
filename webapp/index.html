<!DOCTYPE html>
<html>
	<head>

    	<meta charset="utf-8">
    	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
    	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	    <link href="./img/elsa1.ico" type=image/x-icon rel="shortcut icon" /> 
      <title>Football</title>
	    <!-- Bootstrap -->
	    <link href="css/bootstrap.min.css" rel="stylesheet">
	    <link href="css/index.css" rel="stylesheet">
      

      <!-- <script src="../server/ajax.js" ></script> -->
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
      <script type="text/javascript" src="http://canvasjs.com/assets/script/canvasjs.min.js"></script>

  	<body>
      <div class="left_background"></div>
      <div class="right_background"></div>
      <div class="center_background"></div>
    	<div class="container">
      		<div class="row clearfix">
        		<div class="col-md-12 column">
        		</div>
      		</div>
      		<div class="row clearfix">
        		<div class="col-md-12 column">
          			<form class="form-horizontal form" role="form" id="formSearch">	
              		  <div class="form-group">
      						      <div class="col-md-10 text">
                           <h5 class="guideText">What you want to search:</h5>
      							       <textarea class="col-md-12 inputField" id="player_club" name="player_club" placeholder="e.g. @waynerooney OR #Rooney AND @manutd"/></textarea>
      						      </div>
                        <div class="col-md-10 text">
                          <h5 class="guideText">Whom you want to search from:</h5>
                           <textarea class="col-md-12 inputField" id="author" name="author" placeholder=  "e.g.@waynerooney"></textarea>
                        </div>
      						      <div class="col-md-9"></div>
      						      <div class="col-md-1 submit" >
                    			<button class="btn btn-default" id="submit" type='button'>Submit</button>
                	     </div>
                       <div id="underline_form"><div class="col-md-12 underline_form"></div></div>
              		</div>
      				</form>

              <div id="tweets" class="tweets"></div>
              <div id="chartContainer" class="chartContainer"></div>
	        	</div>
	      	</div>
    	</div>


    <script type="text/javascript">
        function sendAjaxQuery(url, data) { 
            $('#tweets').load('index.html'+' #tweets');
            $.ajax({
                type: 'POST',
                url: 'postFile.html',
                data: data,
                // dataType: 'json',
                success: function (data) {
                  var jsonList = JSON.parse(data);
                  var dataPointArray = [];
                  var lastDate='';
                  var lastDay = 0;
                  var num=-1;

                  //console.log(jsonList);
                  // $('#underline_form').append('<div class="col-md-12 underline_form"></div>');
                  for(var i in jsonList.data){
                        var list = jsonList.data[i];
                        var date = new Date(list.time_str);
                        var day = date.getDate();
                        var month = date.getMonth()+1;
                        var year = date.getFullYear().toString();
                        var date_string = year+'-'+month.toString()+'-'+day;

                        
                        $('#tweets').append('<div class="media">'
                                    +'<a href="#" class="pull-left" style="padding-right:15px;">'
                                    +'<img src="'+list.author_profile_image+'" class="media-object" alt="" style="border-radius:10px;"/>'
                                    +'</a>'
                                    +'<div class="media-body">'
                                    +'<h4 class="media-heading"><a href="https://twitter.com/'+list.author+'">'+list.author+'</a></h4>'
                                    +'<p class="date_string">'+date_string+'</p>'
                                    +'<a style="color:black" href="https://twitter.com/'+list.author+'/status/'+list.tweet_id+'">'+list.contents+'</a>'
                                    +'</div></div>');     


                        if(lastDay === day){
                          var numString = dataPointArray[num];
                          var dataNum = parseInt(numString.y)+1;
                          dataPointArray[num].y = dataNum;
                        }else{
                          num+=1;
                          dataPointArray.push({
                            x:day, y:1
                          });
                        }
                        lastDay = day;

                  }
                    
                  if(dataPointArray.length>0){
                    makeChart(dataPointArray);
                  }else{
                    alert("No result found.")
                  }
                  

                },
                error: function (xhr, status, error) { 
                    console.log('Error: ', error);
                    alert('error connecting'); 
                }
            });
        }

        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        function sendData(){
            var form = document.getElementById('submit');
            sendAjaxQuery('http://localhost:3000/', JSON.stringify($('form').serializeObject()));
        };


        function makeChart(dataPointArray) {

            var chart = new CanvasJS.Chart("chartContainer", {
                      theme: "theme1",//theme1\
                      backgroundColor: "#F3F3F3",
                      title:{
                        text: "Frequency Chart"              
                      },
                      animationEnabled: false,   // change to true
                      data: [              
                      {
                        // Change type to "bar", "area", "spline", "pie",etc.
                        type: "spline",
                        dataPoints: dataPointArray
                      }
                      ]
                    });
                    chart.render();

      };



        var submit = document.getElementById('submit');
        //submit.onclick=sendData;
        if ($("submit").is(":focus")) {
          $("#submit").focus(sendData);
        }else{
          $("#submit").click(sendData);
        }

  
    </script>
  </body>
</html>